ALTER TABLE BOOKS ADD BESTSELLER BOOLEAN;

DROP PROCEDURE IF EXISTS UpdateBestsellers;

DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
    DECLARE RENTEDBOOKS, BKS_ID INT;
    DECLARE FINISHED INT DEFAULT 0;
    DECLARE ALL_BOOKS CURSOR FOR SELECT BOOK_ID FROM BOOKS;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
    OPEN ALL_BOOKS;
    WHILE (FINISHED = 0) DO
        FETCH ALL_BOOKS INTO BKS_ID;
        IF (FINISHED = 0) THEN
            SELECT COUNT(*) FROM RENTS
                WHERE BOOK_ID = BKS_ID INTO RENTEDBOOKS;
            IF (RENTEDBOOKS > 2) THEN
            UPDATE BOOKS SET BESTSELLER = true WHERE BOOK_ID =BKS_ID;
            ELSE
            UPDATE BOOKS SET BESTSELLER = false WHERE BOOK_ID =BKS_ID;
        END IF;
            COMMIT;
        END IF;
        END WHILE;
    CLOSE ALL_BOOKS;
END $$

DELIMITER ;

CALL UpdateBestsellers();

SELECT * FROM BOOKS;
