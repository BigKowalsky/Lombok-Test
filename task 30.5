CREATE TABLE STATS (
                       STAT_ID INT(11) AUTO_INCREMENT PRIMARY KEY,
                       STAT_DATE DATETIME NOT NULL,
                       STAT VARCHAR(20) NOT NULL,
                       VALUE INT(11) NOT NULL
);

DROP VIEW IF EXISTS BESTSELLERS_COUNT;
CREATE VIEW BESTSELLERS_COUNT AS
SELECT COUNT(*) FROM BOOKS WHERE BESTSELLER = 1;

USE KODILLA_COURSE;

DROP EVENT IF EXISTS UPDATE_BESTSELLERS;

DELIMITER $$

CREATE EVENT UPDATE_BESTSELLERS
    ON SCHEDULE EVERY 1 MINUTE
    DO
    BEGIN
        DECLARE BESTIES_COUNT INT DEFAULT 0;
        CALL UpdateBestsellers();
        SELECT * FROM BESTSELLERS_COUNT INTO BESTIES_COUNT;
        INSERT INTO STATS(STAT_DATE, STAT, VALUE)
            VALUE (CURTIME(),'BESTSELLER', BESTIES_COUNT);
    END $$

DELIMITER ;
